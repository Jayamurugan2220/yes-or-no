<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Invite â€” Yes/No Question Share</title>
  <link rel="stylesheet" href="styles.css">
</head>
<script>
(function () {
  // Elements
  const container = document.getElementById('lovable-share');
  if (!container) return;
  const input = document.getElementById('lovable-share-input');
  const generateBtn = document.getElementById('lovable-generate-btn');
  const actions = document.getElementById('lovable-actions');
  const copyBtn = document.getElementById('lovable-copy-btn');
  const openBtn = document.getElementById('lovable-open-btn');
  const statusWrap = document.getElementById('lovable-status');
  const statusText = document.getElementById('lovable-status-text');

  // Helper UI
  function setStatus(text, show = true) {
    statusText.textContent = text || '';
    statusWrap.style.display = show && text ? '' : 'none';
  }
  function showSpinnerOn(btn, text) {
    btn.disabled = true;
    const sp = document.createElement('span');
    sp.className = 'lovable-spinner';
    sp.setAttribute('aria-hidden', 'true');
    btn.prepend(sp);
    if (text) btn.append(` ${text}`);
    return sp;
  }
  function clearSpinnerOn(btn, spinner) {
    btn.disabled = false;
    if (spinner && spinner.parentNode) spinner.remove();
    // remove appended text nodes added above (best-effort)
    btn.childNodes.forEach(n => {
      if (n.nodeType === Node.TEXT_NODE && n.nodeValue.trim() === '') n.remove();
    });
  }

  // Copy helper
  async function copyToClipboard(text) {
    if (!text) return false;
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
        return true;
      } else {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        const ok = document.execCommand('copy');
        ta.remove();
        return !!ok;
      }
    } catch (e) { return false; }
  }

  // Main: obtain share link
  // This function tries multiple strategies:
  // 1) If your site provides window.createShareLink() and it returns a Promise that resolves to the link, it will be used.
  // 2) Else if there is an existing share-input value in the page (with id 'shareInput' or class 'share-input' and not empty),
  //    it will be used as a link or a key to build a link.
  // 3) Else fallback: current page URL (location.href).
  async function obtainShareLink() {
    // 1) try existing generator
    if (typeof window.createShareLink === 'function') {
      // user-provided generator expected to return Promise<string> or string
      try {
        const res = window.createShareLink();
        return (res instanceof Promise) ? await res : res;
      } catch (e) {
        console.warn('createShareLink failed:', e);
      }
    }

    // 2) try reading an existing share input value (common patterns)
    const existing = document.querySelector('.share-input, #shareInput, input[data-share-key]');
    if (existing && existing.value && existing.value.trim()) {
      const val = existing.value.trim();
      // if looks like full URL, return it; else build a friendly link
      if (/^https?:\/\//i.test(val)) return val;
      try {
        // assume it's a key; craft a link to question page with key param
        const u = new URL(location.href);
        // adapt to your app: change pathname if you need
        u.pathname = '/question.html';
        u.searchParams.set('id', val);
        return u.toString();
      } catch (e) {
        return val;
      }
    }

    // 3) fallback: use current page URL
    return location.href;
  }

  // UI: when link ready, reveal copy/open
  function revealActions(link) {
    if (!link) return;
    input.value = link;
    actions.style.display = '';
    copyBtn.disabled = false;
    openBtn.disabled = false;
    setStatus('Link generated â€” you can copy or open it.');
  }

  // Bind events
  generateBtn.addEventListener('click', async function () {
    // prevent double click
    if (this.disabled) return;
    setStatus('', false);
    // hide actions until link is ready
    actions.style.display = 'none';
    input.value = '';
    // show spinner on button
    const spinner = showSpinnerOn(this, 'Generatingâ€¦');

    // attempt to obtain link
    let link;
    try {
      link = await obtainShareLink();
    } catch (e) {
      console.error(e);
      link = null;
    }

    // small delay to make UX smoother if generation is instantaneous
    await new Promise(r => setTimeout(r, 300));

    clearSpinnerOn(this, spinner);

    if (!link) {
      setStatus('Failed to create link. Try again.', true);
      return;
    }
    revealActions(link);
  });

  copyBtn.addEventListener('click', async function () {
    const link = input.value && input.value.trim();
    if (!link) return setStatus('No link to copy.', true);
    this.disabled = true;
    const ok = await copyToClipboard(link);
    this.disabled = false;
    setStatus(ok ? 'Copied to clipboard âœ…' : 'Copy failed â€” try manually.', true);
    // brief success highlight
    if (ok) {
      this.classList.add('pulse');
      setTimeout(()=> this.classList.remove('pulse'), 900);
    }
  });

  openBtn.addEventListener('click', function () {
    const link = input.value && input.value.trim();
    if (!link) return setStatus('No link to open.', true);
    window.open(link, '_blank', 'noopener,noreferrer');
  });

  // keep actions hidden initially
  actions.style.display = 'none';
  setStatus('', false);

  // If a link already exists in the DOM on load (some sites pre-generate), reveal it.
  (async function checkExistingOnLoad(){
    // small delay allowing other scripts to populate share inputs if they run on load
    await new Promise(r => setTimeout(r, 300));
    const maybe = await obtainShareLink();
    // treat current page as non-generated â€” only reveal if it clearly looks like a generated share (contains id or short token)
    if (maybe && maybe !== location.href) {
      revealActions(maybe);
    }
  })();

})();
</script>

<body>
  <div class="page center-viewport">
    <div class="card fade-in float">
      <h1>Yes/No Questions</h1>
      <p id="preview" class="question hint" aria-hidden="true"></p>

      <form id="senderForm" class="sender-form fade-scale" onsubmit="return false;" style="--delay:0.2s">
        <div class="form-group">
          <label class="sr-only" for="senderInput">Your name</label>
          <input id="senderInput" class="share-input" placeholder="Your name (e.g. Alice)" aria-label="Sender name"
                 autocomplete="off" spellcheck="false">
        </div>

        <div class="form-group">
          <label class="sr-only" for="questionInput">Question</label>
          <input id="questionInput" class="share-input" placeholder="Your yes/no question" aria-label="Question"
                 autocomplete="off" spellcheck="false">
        </div>

        <div class="button-group">
          <button id="generateBtn" class="btn primary pulse" type="button">Generate Link</button>
        </div>
      </form>

      <div class="share-section">
        <div class="share">
          <input id="shareInput" class="share-input" readonly aria-label="Shareable link" placeholder="Generated link will appear here">
          <button id="copyBtn" class="btn">Copy link</button>
          <button id="askBtn" class="btn" type="button">Open</button>
        </div>
      </div>

      <p class="hint">Tip: enter your name and question, click Generate Link, then copy and share the link.</p>

      <div style="margin-top: 24px; padding-top: 16px; border-top: 2px solid #eee; text-align: center;">
        <p class="hint">ðŸ“Š Want to see how many people answered your questions?</p>
        <a href="results.html" class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">View My Results ðŸ“ˆ</a>
      </div>
    </div>
  </div>

  <script>
    // helper to get params and decode
    const params = new URLSearchParams(location.search);
    const initialSender = '';
    const initialQuestion = params.get('question') || '';

  const preview = document.getElementById('preview');
  const askBtn = document.getElementById('askBtn');
    const copyBtn = document.getElementById('copyBtn');
    const shareInput = document.getElementById('shareInput');
    const senderInput = document.getElementById('senderInput');
    const questionInput = document.getElementById('questionInput');
    const generateBtn = document.getElementById('generateBtn');

    // populate inputs if params provided
    if (initialSender) senderInput.value = initialSender;
    if (initialQuestion) questionInput.value = initialQuestion;

    function updateInvitePreview(s, q) {
      const who = s && s.trim() ? s.trim() : 'Someone';
      // Update preview only if there's a question
      if (q && q.trim()) {
        preview.textContent = `${who} asks: "${q.trim()}"`;
      } else {
        preview.textContent = '';
      }
    }

    updateInvitePreview(senderInput.value || initialSender, questionInput.value || initialQuestion);

    // Build a direct link to the question page (question.html) with an encoded payload param.
    // The payload is a base64-encoded JSON object {s, q}. The page will read and then remove
    // the query string so the details don't remain visible in the address bar.
    function buildShareUrl(s, q) {
      const u = new URL('question.html', location.href);
      const payloadObj = { s: (s || '').trim(), q: (q || '').trim() };
      try {
        // encode UTF-8 safe base64
        const json = JSON.stringify(payloadObj);
        const base64 = btoa(unescape(encodeURIComponent(json)));
        u.searchParams.set('payload', base64);
      } catch (e) {
        // fallback to plain encoded components if base64 fails
        u.searchParams.set('sender', encodeURIComponent(payloadObj.s));
        u.searchParams.set('question', encodeURIComponent(payloadObj.q));
      }
      return u.toString();
    }

    // When Generate Link is clicked, create the link and place it in the share input
    generateBtn.addEventListener('click', () => {
      const s = senderInput.value;
      const q = questionInput.value;
      if (!s || !s.trim() || !q || !q.trim()) {
        // simple validation
        generateBtn.textContent = 'Fill both fields';
        setTimeout(() => generateBtn.textContent = 'Generate Link', 1400);
        return;
      }
      const url = buildShareUrl(s, q);
      shareInput.value = url;
      updateInvitePreview(s, q);
    });

    copyBtn.addEventListener('click', async () => {
      if (!shareInput.value) {
        // fallback: generate from current inputs
        const url = buildShareUrl(senderInput.value, questionInput.value);
        shareInput.value = url;
      }
      try {
        await navigator.clipboard.writeText(shareInput.value);
        copyBtn.textContent = 'Copied!';
        setTimeout(() => copyBtn.textContent = 'Copy link', 1400);
      } catch (e) {
        shareInput.select();
        document.execCommand('copy');
        copyBtn.textContent = 'Copied!';
        setTimeout(() => copyBtn.textContent = 'Copy link', 1400);
      }
    });

    // Open button should open the direct question page (or generate it first)
    askBtn.addEventListener('click', () => {
      if (!shareInput.value) {
        // generate from inputs
        const s = senderInput.value || initialSender || '';
        const q = questionInput.value || initialQuestion || '';
        shareInput.value = buildShareUrl(s, q);
        updateInvitePreview(s, q);
      }
      try { window.open(shareInput.value, '_blank'); } catch (e) { location.href = shareInput.value; }
    });

    // make the share input clickable to open the link if present
    shareInput.addEventListener('click', () => {
      if (shareInput.value) {
        try { window.open(shareInput.value, '_blank'); } catch (e) { location.href = shareInput.value; }
      }
    });

    // allow Enter to generate link when in question input
    questionInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') generateBtn.click(); });
  </script>
</body>
</html>
